{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="text-center mb-4">
        <h2>üìÖ Daily Panel Challenge</h2>
        <p>Can you guess who drew this panel?</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="position-relative overflow-hidden" style="max-height: 400px;">
                    <img src="{{ panel.content_url }}" 
                         class="img-fluid blur-effect" 
                         id="daily-image">
                </div>
                
                <ul class="list-group list-group-flush" id="clue-list">
                    <li class="list-group-item d-none" id="clue-1"><strong>Clue 1 (First Prompt):</strong> "{{ first_prompt.content_text }}"</li>
                    <li class="list-group-item d-none" id="clue-2"><strong>Clue 2 (Date):</strong> {{ panel.book.game.date.strftime('%Y-%m-%d') }}</li>
                    <li class="list-group-item d-none" id="clue-3"><strong>Clue 3 (Position):</strong> Page {{ panel.sequence }} of {{ panel.book.pages.count() }}</li>
                    <li class="list-group-item d-none" id="clue-4"><strong>Clue 4 (Characters):</strong> 
                        {% for char in panel.characters %}{{ char.name }}{% if not loop.last %}, {% endif %}{% endfor %}
                    </li>
                    <li class="list-group-item d-none" id="clue-5"><strong>Clue 5:</strong> Image Revealed</li>
                </ul>
            </div>

            <div id="game-input-area">
                <select id="author-search" class="form-select mb-2">
                    <option value="">Select an artist...</option>
                    {% for author in authors %}
                    <option value="{{ author.id }}">{{ author.true_name }}</option>
                    {% endfor %}
                </select>
                <button onclick="makeGuess()" class="btn btn-primary w-100">
                    Submit Guess (<span id="guesses-left">6</span> left)
                </button>
            </div>

            <div id="game-over-area" class="mt-4 text-center d-none">
                <div id="status-alert" class="alert shadow">
                    <h4 id="status-title"></h4>
                    <p class="mb-1">The artist was:</p>
                    <h3 class="fw-bold">{{ panel.author_alias.name }}</h3>
                    
                    <div class="mt-3">
                        <a href="{{ url_for('book_detail', book_id=panel.book_id) }}" class="btn btn-sm btn-dark">
                            View Full Book
                        </a>
                        <button onclick="shareScore()" class="btn btn-sm btn-success">
                            Share Results
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .blur-effect { 
        filter: blur(15px); 
        transition: filter 0.5s ease; 
        pointer-events: none;
    }
    /* Simple utility if bootstrap d-none isn't enough */
    .hidden { display: none !important; }
</style>

<script>
    // 1. Setup Variables from Flask
    const correctUserId = {{ correct_author_id | tojson }};
    const challengeId = {{ challenge.id | tojson }};
    const storageKey = `daily_game_${challengeId}`;

    let guesses = 0;
    let gameOver = false;

    // Load saved state if exists
    window.addEventListener('DOMContentLoaded', () => {
        const savedState = localStorage.getItem(storageKey);
        if (savedState) {
            const data = JSON.parse(savedState);
            guesses = data.guesses;
            gameOver = data.gameOver;
            const won = data.won;

            if (gameOver) {
                // If they finished previously, jump straight to the end
                endGame(won, false); // false means "don't save again"
            } else {
                // If they were mid-game, restore their guess count
                updateUI();
            }
        }
    });

    // 2. The Main Guess Function
    function makeGuess() {
        if (gameOver) return;

        const selectEl = document.getElementById('author-search');
        
        // Handle TomSelect or standard Select
        const val = selectEl.tomselect ? selectEl.tomselect.getValue() : selectEl.value;

        if (!val) {
            alert("Please select an artist!");
            return;
        }

        if (val == correctUserId) {
            endGame(true);
        } else {
            guesses++;
            updateUI();
            saveState(false);
            
            if (selectEl.tomselect) selectEl.tomselect.clear();

            selectEl.removeChild(selectEl.querySelector(`option[value="${val}"]`));
            
            if (guesses >= 6) {
                endGame(false);
            }
        }
    }

    function saveState(won) {
        const state = {
            guesses: guesses,
            gameOver: gameOver,
            won: won
        };
        localStorage.setItem(storageKey, JSON.stringify(state));
    }

    // 3. Update Clues and Guesses Left
    function updateUI() {
        // Update "Guesses Left" text
        document.getElementById('guesses-left').innerText = 6 - guesses;

        // Reveal Clues based on guess count
        if (guesses >= 1) document.getElementById('clue-1').classList.remove('d-none');
        if (guesses >= 2) document.getElementById('clue-2').classList.remove('d-none');
        if (guesses >= 3) document.getElementById('clue-3').classList.remove('d-none');
        if (guesses >= 4) document.getElementById('clue-4').classList.remove('d-none');
        if (guesses >= 5) document.getElementById('clue-5').classList.remove('d-none');
        
        // Start reducing blur slightly with each wrong guess (optional touch)
        const img = document.getElementById('daily-image');
        if (guesses < 6) {
            img.style.filter = `blur(${15 - (guesses * 3)}px)`;
        }
    }

    // 4. Handle Win/Loss
    function endGame(won, shouldSave=true) {
        gameOver = true;
        if (shouldSave) saveState(won);
        
        // Unblur completely
        document.getElementById('daily-image').style.filter = "none";
        
        // Hide input, show results
        document.getElementById('game-input-area').classList.add('d-none');
        const overArea = document.getElementById('game-over-area');
        overArea.classList.remove('d-none');

        const alertBox = document.getElementById('status-alert');
        const title = document.getElementById('status-title');

        if (won) {
            const currentStreak = updateStreak();

            title.innerText = "üéâ Correct!";
            alertBox.classList.add('alert-success');

            const streakHtml = `<div class="mt-2"><span class="badge bg-warning text-dark">üî• ${currentStreak} Day Streak</span></div>`;
            alertBox.insertAdjacentHTML('beforeend', streakHtml);
        } else {
            localStorage.setItem(streakKey, JSON.stringify({ count: 0, lastId: challengeId }));
            title.innerText = "‚ùå Game Over";
            alertBox.classList.add('alert-danger');
            // Reveal all clues on loss
            for(let i=1; i<=4; i++) {
                document.getElementById('clue-'+i).classList.remove('d-none');
            }
        }
    }

    // 5. Share Logic
    function shareScore() {
        let squares = "";
        for (let i = 0; i < 6; i++) {
            if (gameOver && i === guesses && !document.getElementById('status-alert').classList.contains('alert-danger')) {
                squares += "üü©";
                break;
            } else if (i < guesses) {
                squares += "üü•";
            } else {
                squares += "‚¨ú";
            }
        }
        const text = `BPP-dle #${challengeId}\n${squares}\n${window.location.href}`;
        navigator.clipboard.writeText(text).then(() => alert("Copied to clipboard!"));
    }

    // 6. Streak Tracking
    const streakKey = 'daily_panel_streak';

    function updateStreak() {
        let streakData = JSON.parse(localStorage.getItem(streakKey)) || { count: 0, lastId: 0 };
        
        // 1. Check if they already counted today (prevents double-counting on refresh)
        if (streakData.lastId === challengeId) return streakData.count;

        // 2. Check if the last win was "Yesterday" (ChallengeID - 1)
        // If they missed a day, the ID won't match, so reset to 1.
        if (streakData.lastId === challengeId - 1) {
            streakData.count += 1;
        } else {
            streakData.count = 1;
        }

        // 3. Update the storage
        streakData.lastId = challengeId;
        localStorage.setItem(streakKey, JSON.stringify(streakData));
        
        return streakData.count;
    }

    function getDisplayStreak() {
        const streakData = JSON.parse(localStorage.getItem(streakKey));
        return streakData ? streakData.count : 0;
    }
</script>
{% endblock %}
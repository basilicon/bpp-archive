{% extends 'base.html' %}

{% block og_title %}Panel #{{ panel.sequence }} from Book #{{ panel.book.id }}{% endblock %}
{% block og_desc %}Created by {{ panel.author_alias.name }}{% endblock %}
{% block og_image %}{{ panel.content_url }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('game_detail', game_id=panel.book.game_id) }}">Game</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('book_detail', book_id=panel.book.id) }}">Owning Book</a>
            </li>
            <li class="breadcrumb-item active">Panel #{{ panel.sequence }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow">
                {% if panel.type == 'image' %}
                <img src="{{ panel.content_url }}" class="img-fluid rounded-start" alt="BPP Drawing">
                {% else %}
                <div class="card-body py-5 text-center">
                    {% for line in panel.content_text.splitlines() %}
                    <h2 class="fst-italic">"{{ line }}"</h2>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="card-footer text-muted">
                    Created by: <a href="{{ url_for('user_detail', user_id=panel.author_alias.user_id) }}">
                        <strong>{{ panel.author_alias.name }}</strong>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Characters</h5>
                    <span class="badge bg-primary">{{ panel.characters|length }}</span>
                </div>

                <div class="card-body p-0">
                    {% if session.get('is_admin') %}
                    <style>
                        /* Ensure TomSelect takes up the remaining space but leaves room for the button */
                        .input-group .ts-wrapper {
                            flex: 1 1 auto;
                            width: 1% !important; /* Forces the flexbox to calculate width correctly */
                            min-width: 0;
                        }

                        /* Fixes border-radius issues when items are grouped */
                        .input-group .ts-control {
                            border-top-right-radius: 0 !important;
                            border-bottom-right-radius: 0 !important;
                        }

                        #recent-tags-list button {
                            border-style: dashed;
                            transition: all 0.2s;
                        }
                        #recent-tags-list button:hover {
                            border-style: solid;
                            background-color: #e9ecef;
                        }

                        .text-success {
                            font-size: 0.75rem;
                            font-style: italic;
                            animation: fadeIn 0.5s ease-in;
                        }

                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                    </style>

                    <div class="p-3 border-bottom bg-light">
                        <label class="small fw-bold text-muted mb-1">Tag Existing:</label>
                        <form action="{{ url_for('tag_character') }}" method="POST" class="mb-3">
                            <input type="hidden" name="page_id" value="{{ panel.id }}">
                            
                            <div class="input-group input-group-sm">
                                <select id="char-search" name="character_id" placeholder="Search..." autocomplete="off">
                                    <option value="">Search characters...</option>
                                    {% for char in all_characters %}
                                        <option value="{{ char.id }}" data-src="{{ char.image_url or url_for('static', filename='default_char.png') }}">
                                            {{ char.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn btn-success px-3" style="z-index: 5;">Tag</button>
                            </div>
                        </form>

                        <div id="recent-tags-container" class="mb-2 d-none">
                            <label class="small fw-bold text-muted mb-1">Recently Tagged:</label>
                            <div id="recent-tags-list" class="d-flex flex-wrap gap-1">
                                </div>
                        </div>

                        <hr>

                        <label class="small fw-bold text-muted mb-1">Create New:</label>
                        <form action="{{ url_for('add_character') }}" method="POST" class="d-flex gap-2">
                            <input type="hidden" name="page_id" value="{{ panel.id }}">
                            <input type="text" name="name" class="form-control form-control-sm" placeholder="Character Name" required>
                            <button type="submit" class="btn btn-sm btn-primary">Create</button>
                        </form>
                    </div>

                    <script>
                        const maxRecentTags = 5;

                        document.addEventListener("DOMContentLoaded", function() {
                            const tomSelect = new TomSelect("#char-search", {
                                create: false,
                                sortField: { field: "text", direction: "asc" }
                            });

                            const STORAGE_KEY = 'bpp_recent_characters';

                            function addCharToUI(id, name, imgSrc) {
                                const noCharsMsg = document.getElementById('no-chars-msg');
                                if (noCharsMsg) noCharsMsg.remove();

                                if (document.getElementById(`char-tag-${id}`)) return;

                                // Use the passed imgSrc, or a default if null
                                const finalImg = imgSrc || '/static/default_char.png';

                                const html = `
                                    <div class="list-group-item d-flex justify-content-between align-items-center" id="char-tag-${id}">
                                        <div class="d-flex align-items-center text-dark flex-grow-1">
                                            <img src="${finalImg}" class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">
                                            <div>
                                                <div class="fw-bold">${name}</div>
                                                <small class="text-success">Just added!</small>
                                            </div>
                                        </div>
                                    </div>`;
                                document.getElementById('character-list-container').insertAdjacentHTML('afterbegin', html);
                            }

                            async function silentTag(id, name, imgSrc) {
                                // 1. Update UI immediately (Optimistic)
                                addCharToUI(id, name, imgSrc);
                                
                                const formData = new FormData();
                                formData.append('page_id', '{{ panel.id }}');
                                formData.append('character_id', id);

                                try {
                                    const response = await fetch("{{ url_for('tag_character') }}", {
                                        method: "POST",
                                        body: formData,
                                        headers: {
                                            'X-Requested-With': 'XMLHttpRequest'
                                        }
                                    });

                                    if (response.ok) {
                                        // 2. Success: Finalize the state
                                        saveToRecent(id, name, imgSrc);
                                        renderRecentTags();
                                        tomSelect.clear();
                                    } else {
                                        // 3. Server error: Remove from UI and alert user
                                        handleTagError(id, "Server rejected the tag.");
                                    }
                                } catch (error) {
                                    // 4. Network error: Remove from UI
                                    handleTagError(id, "Network error. Tag not saved.");
                                    console.error("Network error:", error);
                                }
                            }

                            // Helper to undo the UI change
                            function handleTagError(id, message) {
                                const el = document.getElementById(`char-tag-${id}`);
                                if (el) {
                                    el.style.transition = "all 0.4s";
                                    el.style.backgroundColor = "#f8d7da"; // Red flash for error
                                    setTimeout(() => {
                                        el.remove();
                                        alert(message);
                                    }, 500);
                                }
                            }

                            function saveToRecent(id, name, imgSrc) {
                                let recent = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                                recent = recent.filter(item => item.id !== id);
                                recent.unshift({ id, name, imgSrc }); // Store the image URL
                                localStorage.setItem(STORAGE_KEY, JSON.stringify(recent.slice(0, maxRecentTags)));
                            }

                            function renderRecentTags() {
                                const recent = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                                const recentList = document.getElementById('recent-tags-list');
                                if (recent.length === 0) return;

                                // 1. Get all valid IDs currently available in the TomSelect dropdown
                                // This represents the "Source of Truth" from the server
                                const validIds = Object.keys(tomSelect.options);

                                // 2. Filter the cached list to only include IDs that still exist on the server
                                const filteredRecent = recent.filter(char => validIds.includes(String(char.id)));

                                // 3. If we removed anything, update localStorage to keep it clean
                                if (filteredRecent.length !== recent.length) {
                                    localStorage.setItem(STORAGE_KEY, JSON.stringify(filteredRecent));
                                }

                                if (filteredRecent.length === 0) {
                                    document.getElementById('recent-tags-container').classList.add('d-none');
                                    return;
                                }
                                
                                document.getElementById('recent-tags-container').classList.remove('d-none');
                                recentList.innerHTML = '';

                                filteredRecent.forEach(char => {
                                    const btn = document.createElement('button');
                                    btn.type = 'button';
                                    btn.className = 'btn btn-sm btn-outline-secondary py-0 px-2 small';
                                    btn.innerText = `+ ${char.name}`;
                                    // Pass the stored image URL back into the tag function
                                    btn.onclick = () => silentTag(char.id, char.name, char.imgSrc);
                                    recentList.appendChild(btn);
                                });
                            }

                            const tagForm = document.querySelector('form[action="{{ url_for("tag_character") }}"]');

                            tagForm.onsubmit = (e) => {
                                e.preventDefault();
                                const id = tomSelect.getValue();
                                
                                // Check if an ID is actually selected
                                if (!id) return;

                                // 1. Find the actual <option> element in the original <select>
                                const originalOption = document.querySelector(`#char-search option[value="${id}"]`);
                                
                                // 2. Safely grab the text and data-src
                                const name = originalOption ? originalOption.text : "Unknown";
                                const imgSrc = originalOption ? originalOption.dataset.src : '/static/default_char.png';
                                
                                silentTag(id, name, imgSrc);
                            };

                            const createForm = document.querySelector('form[action="{{ url_for("add_character") }}"]');

                            createForm.onsubmit = async (e) => {
                                e.preventDefault();
                                
                                const formData = new FormData(createForm);
                                const nameInput = createForm.querySelector('input[name="name"]');

                                try {
                                    const response = await fetch("{{ url_for('add_character') }}", {
                                        method: "POST",
                                        body: formData,
                                        headers: { "X-Requested-With": "XMLHttpRequest" }
                                    });

                                    if (response.ok) {
                                        const data = await response.json();

                                        console.log("Character created:", data);
                                        
                                        const imgSrc = data.imgSrc || "{{ panel.content_url }}";

                                        // 1. Add to the list on the right
                                        addCharToUI(data.id, data.name, imgSrc);
                                        
                                        // 2. Save to recent tags and re-render them
                                        saveToRecent(data.id, data.name, imgSrc);
                                        renderRecentTags();
                                        
                                        // 3. Clear the input
                                        nameInput.value = '';
                                    }
                                } catch (error) {
                                    console.error("Error creating character:", error);
                                }
                            };

                            renderRecentTags();
                        });
                    </script>


                    {% endif %}

                    <div id="character-list-container" class="list-group list-group-flush overflow-auto" style="max-height: 400px;">
                        {% if panel.characters %}
                        {% for char in panel.characters %}
                        <div id="char-tag-{{ char.id }}" class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{{ url_for('character_detail', char_id=char.id) }}"
                                class="d-flex align-items-center text-decoration-none text-dark flex-grow-1">
                                <img src="{{ char.image_url or url_for('static', filename='default_char.png') }}"
                                    class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">
                                <div>
                                    <div class="fw-bold">{{ char.name }}</div>
                                    <small class="text-muted">View Profile</small>
                                </div>
                            </a>

                            {% if session.get('is_admin') %}
                            <form action="{{ url_for('untag_character') }}" method="POST"
                                onsubmit="return confirm('Remove this tag?');">
                                <input type="hidden" name="page_id" value="{{ panel.id }}">
                                <input type="hidden" name="character_id" value="{{ char.id }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger border-0">
                                    <i class="bi bi-x-circle-fill"></i> &times;
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% else %}
                        <div id="no-chars-msg" class="p-4 text-center text-muted">
                            <p>No characters tagged in this panel yet.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}